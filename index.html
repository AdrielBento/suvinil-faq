<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Central de Ajuda ‚Äî Suvinil</title>
  <meta name="description" content="FAQ da Suvinil com pesquisa, categorias e um chat de assist√™ncia." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* THEME TOKENS */
    :root{
      --brand:#f37021;            /* Suvinil orange */
      --brand-600:#e56213;
      --brand-700:#cf5208;
      --ink:#1f2328;
      --muted:#6b7280;
      --bg:#fafafa;
      --card:#ffffff;
      --ring: color-mix(in oklab, var(--brand), white 60%);
      --radius:16px;
      --shadow:0 8px 20px rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark){
      :root:not([data-theme='light']){
        --bg:#0b0c0e; --card:#111317; --ink:#e5e7eb; --muted:#9aa0aa; --shadow:0 8px 20px rgba(0,0,0,.35);
      }
    }
    :root[data-theme='dark']{ --bg:#0b0c0e; --card:#111317; --ink:#e5e7eb; --muted:#9aa0aa; --shadow:0 8px 20px rgba(0,0,0,.35);} 

    /* RESET & BASICS */
    *{box-sizing:border-box}
    html{color-scheme:light dark}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;color:var(--ink);background:var(--bg);line-height:1.5;}
    a{color:var(--brand-700); text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1120px;margin-inline:auto;padding:24px}

    /* HEADER */
    header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(180%) blur(8px);background:color-mix(in oklab, var(--bg), transparent 10%);border-bottom:1px solid color-mix(in oklab, var(--muted), transparent 80%)}
    .nav{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:12px 24px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    .brand-badge{width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg, var(--brand), var(--brand-700));display:grid;place-items:center;color:white;font-size:16px;box-shadow:var(--shadow)}
    .actions{display:flex;gap:10px;align-items:center}
    .icon-btn{border:1px solid color-mix(in oklab, var(--muted), transparent 75%);background:var(--card);padding:8px 12px;border-radius:999px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
    .icon-btn:hover{border-color:var(--ring)}
    .searchbar{flex:1;max-width:720px;display:flex;gap:8px;align-items:center;background:var(--card);padding:10px 12px;border-radius:999px;border:1px solid color-mix(in oklab, var(--muted), transparent 70%);box-shadow:var(--shadow)}
    .searchbar input{flex:1;border:none;outline:none;background:transparent;color:inherit;font-size:15px}
    .searchbar button{appearance:none;border:none;background:var(--brand);color:white;padding:10px 16px;border-radius:999px;font-weight:600;cursor:pointer;transition:transform .06s ease, background .2s ease}
    .searchbar button:hover{background:var(--brand-600)}

    /* HERO */
    .hero{margin-top:12px;border-radius:var(--radius);overflow:hidden;display:grid;grid-template-columns:1.1fr .9fr;min-height:280px;background:linear-gradient(180deg, color-mix(in oklab, var(--brand), transparent 85%), transparent 85%), url('https://images.unsplash.com/photo-1519710164239-da123dc03ef4?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat}
    .hero > section{grid-column:1 / -1;display:grid;align-content:end;background:linear-gradient(180deg, transparent 30%, rgba(0,0,0,.32));color:white;padding:24px}
    .hero h1{margin:0 0 8px;font-size:clamp(24px, 3vw, 36px)}
    .quick-search{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .quick-search a{background:rgba(255,255,255,.15);color:white;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.35);font-size:13px;text-decoration:none}

    /* CATEGORIES */
    .section{margin-top:28px}
    .section h2{font-size:clamp(18px,2vw,22px);margin:0 0 12px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .cat{grid-column:span 4;background:var(--card);border-radius:14px;padding:18px;display:flex;gap:12px;align-items:center;border:1px solid color-mix(in oklab, var(--muted), transparent 75%);box-shadow:var(--shadow);transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease;cursor:pointer}
    .cat:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,0,0,.10);border-color:var(--ring)}
    .cat .icon{width:40px;height:40px;border-radius:10px;background:color-mix(in oklab, var(--brand), white 70%);display:grid;place-items:center;font-weight:700;color:var(--brand-700)}
    .cat h3{margin:0;font-size:16px}
    .cat p{margin:2px 0 0;font-size:13px;color:var(--muted)}

    /* FAQ */
    .faq{display:grid;gap:8px}
    details.faq-item{background:var(--card);padding:14px 16px;border-radius:12px;border:1px solid color-mix(in oklab, var(--muted), transparent 75%);box-shadow:var(--shadow)}
    details summary{list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:16px;font-weight:600}
    details summary::-webkit-details-marker{display:none}

    /* link list style for category results */
    .faq-list{background:var(--card);border:1px solid color-mix(in oklab, var(--muted), transparent 75%);border-radius:12px;box-shadow:var(--shadow)}
    .faq-list a{display:block;padding:14px 16px;color:inherit;text-decoration:none;font-weight:600}
    .faq-list a + a{border-top:1px solid color-mix(in oklab, var(--muted), transparent 85%)}
    .faq-list a:hover{background:color-mix(in oklab, var(--brand), white 92%)}

    /* CONTACT CARDS */
    .contact{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{grid-column:span 4;background:var(--card);border-radius:14px;padding:18px;border:1px solid color-mix(in oklab, var(--muted), transparent 75%);box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:999px;background:var(--brand);color:white;text-decoration:none;font-weight:600;border:0}
    .btn:hover{background:var(--brand-600)}

    /* CHAT WIDGET (base) */
    .chat-toggle{display:none}
    .chat-drawer{position:fixed;right:18px;bottom:86px;width:min(380px, calc(100vw - 36px));height:min(72vh, 680px);height:min(72dvh, 680px);border:1px solid color-mix(in oklab, var(--muted), transparent 70%);border-radius:16px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.35);background:var(--card);display:none;flex-direction:column}
    .chat-drawer.open{display:flex}
    .chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid color-mix(in oklab, var(--muted), transparent 80%)}
    .chat-title{display:flex;gap:10px;align-items:center}
    .bot-badge{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg, var(--brand), var(--brand-700));color:white;display:grid;place-items:center;font-weight:700}
    .chat-body{flex:1;overflow:auto;padding:14px;background:linear-gradient(180deg, color-mix(in oklab, var(--bg), transparent 0%), color-mix(in oklab, var(--bg), white 6%) 100%);padding-bottom:calc(14px + var(--kb-offset, 0px))}
    .msg{display:flex;gap:10px;margin:8px 0}
    .msg.bot{align-items:flex-start}
    .msg.user{flex-direction:row-reverse}
    .bubble{max-width:76%;padding:10px 12px;border-radius:14px;border:1px solid color-mix(in oklab, var(--muted), transparent 70%);background:var(--card);box-shadow:var(--shadow)}
    .msg.bot .bubble{background:color-mix(in oklab, var(--brand), white 88%);border-color:var(--ring)}
    .msg.user .bubble{background:color-mix(in oklab, var(--ink), white 90%)}
    .chat-input{border-top:1px solid color-mix(in oklab, var(--muted), transparent 80%);padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px;padding-bottom:calc(10px + var(--kb-offset, 0px))}
    .chat-input textarea{resize:none;min-height:42px;max-height:160px;border-radius:12px;border:1px solid color-mix(in oklab, var(--muted), transparent 70%);padding:10px 12px;background:var(--card);color:inherit}
    .chip-row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 2px}
    .chip{border:1px solid color-mix(in oklab, var(--muted), transparent 70%);background:transparent;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}

    /* CHAT APP LAYOUT (embedded) */
    .chat-app{display:grid;grid-template-columns:300px 1fr;gap:12px}
    .threads{background:var(--card);border:1px solid color-mix(in oklab, var(--muted), transparent 75%);border-radius:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:480px}
    .threads-head{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid color-mix(in oklab, var(--muted), transparent 85%)}
    .threads-search{flex:1;border:1px solid color-mix(in oklab, var(--muted), transparent 75%);border-radius:999px;padding:8px 12px;background:var(--card);color:inherit}
    .threads-list{flex:1;overflow:auto}
    .thread-item{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;padding:10px 12px;border-bottom:1px solid color-mix(in oklab, var(--muted), transparent 90%);text-decoration:none;color:inherit}
    .thread-item:hover{background:color-mix(in oklab, var(--brand), white 94%)}
    .thread-item.active{background:color-mix(in oklab, var(--brand), white 88%)}
    .thread-title{font-weight:600}
    .thread-meta{color:var(--muted);font-size:12px}
    .thread-actions{display:flex;gap:6px}
    .thread-actions button{border:1px solid color-mix(in oklab, var(--muted), transparent 75%);background:transparent;border-radius:8px;padding:4px 6px;cursor:pointer}
    .thread-right{display:flex;gap:8px;align-items:center}
    .count-badge{min-width:22px;height:22px;border-radius:999px;border:1px solid color-mix(in oklab, var(--muted), transparent 75%);display:grid;place-items:center;font-size:12px;padding:0 6px}

    .chat-col{min-height:480px}
    .chat-drawer.embedded{position:relative;inset:auto;width:100%;height:min(68dvh, 720px);display:flex;border:1px solid color-mix(in oklab, var(--muted), transparent 70%);border-radius:16px;box-shadow:var(--shadow)}

    /* FOOTER */
    footer{margin-top:40px;padding:24px;color:var(--muted);text-align:center;font-size:13px}

    /* RESPONSIVE */
    @media (max-width: 900px){.hero{grid-template-columns:1fr}.cat{grid-column:span 6}.chat-app{grid-template-columns:1fr}.threads{order:2}.chat-col{order:1}}
    @media (max-width: 640px){.grid{gap:10px}.cat{grid-column:span 12}.nav{flex-wrap:wrap;gap:10px}.searchbar{order:2;width:100%}
      .chat-drawer{left:0;right:0;bottom:0;top:auto;width:100vw;height:calc(100dvh - env(safe-area-inset-bottom,0px));max-height:100dvh;border-radius:0}
      .chat-input{padding:12px;padding-bottom:calc(12px + env(safe-area-inset-bottom,0px) + var(--kb-offset,0px))}
      .bubble{max-width:92%}
    }
  </style>
</head>
<body>
  <header>
    <div class="nav container">
      <div class="brand" aria-label="Suvinil">
        <div class="brand-badge" aria-hidden="true">S</div>
        <span>Central de Ajuda ‚Ä¢ Suvinil</span>
      </div>
      <form class="searchbar" role="search" aria-label="Pesquisar artigos" onsubmit="event.preventDefault(); performSearch();">
        <input id="search" type="search" placeholder="Digite sua d√∫vida‚Ä¶" aria-label="Digite sua d√∫vida" />
        <button type="submit" title="Pesquisar (‚åòK)" aria-label="Pesquisar">Pesquisar</button>
      </form>
      <div class="actions">
        <button id="theme-btn" class="icon-btn" aria-label="Alternar tema">
          <span id="theme-ico">üåô</span><span class="hide-sm">Tema</span>
        </button>
        <button id="open-chat" class="icon-btn" aria-label="Ir para o chat">üí¨ Chat</button>
      </div>
    </div>
  </header>

  <main class="container">
    <figure class="hero" aria-label="Hero com destaque visual">
      <section>
        <h1>Como podemos ajudar?</h1>
        <p>Pesquise por palavras‚Äëchave, navegue por categorias ou converse com nosso assistente.</p>
        <div class="quick-search" aria-label="Sugest√µes r√°pidas">
          <a href="#faq">Troca e devolu√ß√£o</a>
          <a href="#faq">Cores</a>
          <a href="#faq">Self‚ÄëColor</a>
          <a href="#faq">Produtos</a>
        </div>
      </section>
    </figure>

    <section class="section" aria-labelledby="cats-title">
      <h2 id="cats-title">Navegue por categorias</h2>
      <div class="grid" id="cats">
        <a class="cat" data-cat="Produtos" href="#faq"><div class="icon">üé®</div><div><h3>Produtos</h3><p>Acabamentos, linhas e indica√ß√£o de uso.</p></div></a>
        <a class="cat" data-cat="Aplica√ß√£o" href="#faq"><div class="icon">üß∞</div><div><h3>Aplica√ß√£o</h3><p>Preparo da superf√≠cie, rendimento e etapas.</p></div></a>
        <a class="cat" data-cat="Cores" href="#faq"><div class="icon">üåà</div><div><h3>Cores</h3><p>Como escolher, combinar e manter.</p></div></a>
        <a class="cat" data-cat="Self-Color" href="#faq"><div class="icon">üß™</div><div><h3>Self‚ÄëColor</h3><p>Tingimento e d√∫vidas comuns.</p></div></a>
        <a class="cat" data-cat="Troca e devolu√ß√£o" href="#faq"><div class="icon">üîÅ</div><div><h3>Troca e devolu√ß√£o</h3><p>Pol√≠tica, prazos e acompanhamento.</p></div></a>
        <a class="cat" data-cat="Outras d√∫vidas" href="#faq"><div class="icon">üí¨</div><div><h3>Outras d√∫vidas</h3><p>Quando n√£o souber por onde come√ßar.</p></div></a>
        <a class="cat" data-cat="Plataformas" href="#faq"><div class="icon">üîå</div><div><h3>Plataformas</h3><p>Conta, senha e acesso.</p></div></a>
        <a class="cat" data-cat="Programas" href="#faq"><div class="icon">ü§ù</div><div><h3>Programas</h3><p>Relacionamento e benef√≠cios.</p></div></a>
      </div>
    </section>

    <section id="faq" class="section" aria-labelledby="faq-title">
      <div class="faq-header">
        <h2 id="faq-title">D√∫vidas frequentes</h2>
        <div id="faq-subtitle" style="color:var(--muted);margin-top:2px"></div>
      </div>
      <div class="faq" id="faq-list"></div>
    </section>

    <section class="section" aria-labelledby="contact-title">
      <h2 id="contact-title">N√£o encontrou o que procurava?</h2>
      <p>Fale com a gente pelos canais abaixo.</p>
      <div class="contact">
        <article class="card"><h3>Telefone</h3><p><strong>0800 011 7558</strong><br><small>Seg. a sex., 8h‚Äì17h</small></p><a class="btn" href="tel:08000117558" aria-label="Ligar para 0800 011 7558">Ligar</a></article>
        <article class="card"><h3>E‚Äëmail</h3><p>Envie sua mensagem e retornamos assim que poss√≠vel.</p><a class="btn" href="mailto:suporte@example.com">Enviar mensagem</a></article>
        <article class="card"><h3>Chat online</h3><p><small>Seg. a sex., 8h‚Äì19h</small></p><a class="btn" href="#" onclick="toggleChat(true);return false;">Iniciar chat</a></article>
      </div>
    </section>
  </main>

  <!-- CHAT HUB (embedded) -->
  <section id="chat-hub" class="section" aria-labelledby="chat-hub-title">
    <div class="container" style="padding-top:0">
      <h2 id="chat-hub-title">Converse com o Assistente</h2>
      <div class="chat-app" id="chat-app">
        <aside class="threads" id="threads" aria-label="Hist√≥rico de conversas">
          <div class="threads-head">
            <button class="btn" id="new-thread" aria-label="Iniciar nova conversa">+ Nova conversa</button>
            <input id="thread-search" class="threads-search" type="search" placeholder="Buscar conversa" aria-label="Buscar conversa"/>
          </div>
          <nav class="threads-list" id="threads-list" role="list"></nav>
        </aside>

        <section class="chat-col" aria-label="√Årea do chat">
          <aside class="chat-drawer embedded" id="chat">
            <div class="chat-head">
              <div class="chat-title"><div class="bot-badge">S</div><div>
                <strong>Assistente Suvinil</strong><br><small style="color:var(--muted)">Produtos ‚Ä¢ Aplica√ß√£o ‚Ä¢ Cores ‚Ä¢ Trocas</small></div></div>
              <div class="actions">
                <button class="icon-btn" id="maximize-chat" aria-label="Maximizar/Restaurar">‚õ∂</button>
              </div>
            </div>
            <div class="chat-body" id="chat-body" aria-live="polite"></div>
            <div class="chat-input">
              <div>
                <div class="chip-row" id="chips"></div>
                <textarea id="chat-input" placeholder="Escreva sua d√∫vida (Shift+Enter para quebrar linha)‚Ä¶" aria-label="Mensagem"></textarea>
              </div>
              <button class="btn" id="send-btn" aria-label="Enviar mensagem">Enviar</button>
            </div>
          </aside>
        </section>
      </div>
    </div>
  </section>

  <footer>
    <div class="container">
      <p>¬© <span id="year"></span> Suvinil ‚Ä¢ Central de Ajuda ‚Ä¢ <a href="#">Pol√≠tica de privacidade</a></p>
      <p><small>Dica: pressione <kbd>‚åò</kbd><kbd>K</kbd> ou <kbd>Ctrl</kbd><kbd>K</kbd> para pesquisar.</small></p>
    </div>
  </footer>

  <script>
    /* ---------- FAQ data ---------- */
    const CAT_QUESTIONS = {
      'Produtos': [
        'Quais produtos e t√©cnicas devo utilizar para pintar azulejos?',
        'Como obter a Ficha de Informa√ß√£o de Seguran√ßa de Produto Qu√≠mico (FISPQ)?',
        'Como posso obter o boletim t√©cnico?',
        'Qual o rendimento dos produtos?',
        'Ferramentas para escolha de cor - Leque de cores / Adesivos / Colorir / Teste sua Cor',
        'Quais s√£o os produtos lav√°veis?',
        'Quais s√£o os produtos recomendados para madeira?',
        'Quais ferramentas (pincel, trincha, rolo, pistola) devo utilizar na aplica√ß√£o da tinta?',
        'Como fa√ßo para impermeabilizar uma superf√≠cie?',
        'Quais cuidados devo adotar no descarte de res√≠duos e latas de tintas?',
        'Como fa√ßo para conhecer e escolher um produto?'
      ],
      'Aplica√ß√£o': [
        'Como preparar a superf√≠cie antes de pintar?',
        'Quantas dem√£os devo aplicar?',
        'Qual o tempo de secagem entre dem√£os?',
        'Como calcular a quantidade de tinta?'
      ],
      'Cores': [
        'Como escolher cores para ambientes pequenos?',
        'Como combinar cores quentes e frias?',
        'Como manter a cor ao retocar paredes?'
      ],
      'Self-Color': [
        'O que √© o sistema Self-Color?',
        'Como repetir a mesma cor no futuro?',
        'Como ler o r√≥tulo com a receita da cor?'
      ],
      'Troca e devolu√ß√£o': [
        'Como solicitar troca ou devolu√ß√£o?',
        'Quais itens n√£o podem ser devolvidos?',
        'Qual o prazo para devolu√ß√£o?'
      ],
      'Outras d√∫vidas': [
        'Como falar com o suporte?',
        'Onde encontro lojas parceiras?'
      ],
      'Plataformas': [
        'Esqueci minha senha. E agora?',
        'Como atualizar meus dados de cadastro?'
      ],
      'Programas': [
        'Como participar de programas de relacionamento?',
        'Quais s√£o os benef√≠cios dispon√≠veis?'
      ]
    };

    const faqList = document.getElementById('faq-list');
    const faqTitle = document.getElementById('faq-title');
    const faqSubtitle = document.getElementById('faq-subtitle');

    function renderCategory(cat){
      const items = CAT_QUESTIONS[cat] || [];
      faqTitle.textContent = cat || 'D√∫vidas frequentes';
      faqSubtitle.textContent = items.length ? 'D√∫vidas relacionadas' : '';
      if(items.length){
        const wrapper = document.createElement('div');
        wrapper.className = 'faq-list';
        wrapper.setAttribute('role','list');
        items.forEach(q => {
          const a = document.createElement('a');
          a.href = '#'; a.setAttribute('role','listitem'); a.textContent = q;
          a.addEventListener('click', (e)=>{ e.preventDefault(); addUser(q); respond(q); persist(); });
          wrapper.appendChild(a);
        });
        faqList.replaceChildren(wrapper);
      } else { faqList.textContent = 'Nada encontrado para esta categoria.'; }
      document.getElementById('faq').scrollIntoView({behavior:'smooth'});
    }

    // default list
    renderCategory('Produtos');

    // category clicks
    document.querySelectorAll('.cat').forEach(el=>{
      el.addEventListener('click', ()=>{ const cat = el.getAttribute('data-cat'); renderCategory(cat); });
    });

    /* ---------- Search ---------- */
    function performSearch(){
      const term = (document.getElementById('search').value || '').trim().toLowerCase();
      if(!term){ document.getElementById('search').focus(); return; }
      const results = [];
      for(const [cat, list] of Object.entries(CAT_QUESTIONS)){
        list.forEach(q=>{ if(q.toLowerCase().includes(term)) results.push({cat, q}); });
      }
      faqTitle.textContent = 'Resultados da busca';
      faqSubtitle.textContent = `${results.length} resultado(s)`;
      if(results.length){
        const wrapper = document.createElement('div');
        wrapper.className = 'faq-list';
        results.forEach(({q})=>{
          const a = document.createElement('a'); a.href='#'; a.textContent=q; a.addEventListener('click',(e)=>{e.preventDefault(); addUser(q); respond(q); persist();}); wrapper.appendChild(a);
        });
        faqList.replaceChildren(wrapper);
        document.getElementById('faq').scrollIntoView({behavior:'smooth'});
      } else { faqList.textContent = 'Nenhum resultado encontrado.'; }
    }

    /* ---------- Theme toggle ---------- */
    const root = document.documentElement;
    const themeBtn = document.getElementById('theme-btn');
    const themeIco = document.getElementById('theme-ico');
    function applyTheme(t){ root.setAttribute('data-theme', t); localStorage.setItem('theme', t); themeIco.textContent = t==='dark' ? 'üåû' : 'üåô'; }
    (function initTheme(){
      const saved = localStorage.getItem('theme');
      if(saved === 'dark' || saved === 'light'){ applyTheme(saved); }
    })();
    themeBtn.addEventListener('click', ()=>{
      const cur = root.getAttribute('data-theme') || 'light';
      applyTheme(cur==='light' ? 'dark' : 'light');
    });

    /* ---------- Chat Assistant (demo retrieval) + Threads ---------- */
    const chat = document.getElementById('chat');
    const chatBody = document.getElementById('chat-body');
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chips = document.getElementById('chips');
    const maximizeBtn = document.getElementById('maximize-chat');
    const openChatBtn = document.getElementById('open-chat');

    const THREADS_KEY = 'suv-threads';
    const ACTIVE_KEY = 'suv-active-thread';
    const threadsListEl = document.getElementById('threads-list');
    const newThreadBtn = document.getElementById('new-thread');
    const threadSearch = document.getElementById('thread-search');

    let threads = [];
    let activeThreadId = null;

    function uid(){ return 't_'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
    function loadState(){ try{ threads = JSON.parse(localStorage.getItem(THREADS_KEY) || '[]'); activeThreadId = localStorage.getItem(ACTIVE_KEY) || null; }catch{ threads = []; activeThreadId = null; } }
    function saveState(){ localStorage.setItem(THREADS_KEY, JSON.stringify(threads)); if(activeThreadId) localStorage.setItem(ACTIVE_KEY, activeThreadId); }
    function threadById(id){ return threads.find(t=>t.id===id); }

    function renderThreads(filter=''){
      const frag = document.createDocumentFragment(); const q = filter.trim().toLowerCase();
      threads.slice().sort((a,b)=> (b.updatedAt||b.createdAt) - (a.updatedAt||a.createdAt))
        .filter(t=> !q || (t.title||'').toLowerCase().includes(q) || (t.preview||'').toLowerCase().includes(q))
        .forEach(t=>{
          const a = document.createElement('a'); a.href = '#'; a.className = 'thread-item'+(t.id===activeThreadId?' active':''); a.setAttribute('role','listitem');
          const left = document.createElement('div');
          const title = document.createElement('div'); title.className='thread-title'; title.textContent = t.title || 'Conversa';
          const count = (t.messages||[]).length;
          const lastRole = (t.messages||[])[count-1]?.role || 'bot';
          const who = lastRole==='bot' ? 'bot' : 'voc√™';
          const meta = document.createElement('div'); meta.className='thread-meta'; meta.textContent = `${count} msg${count!==1?'s':''} ‚Ä¢ √∫ltimo: ${who} ‚Ä¢ ${new Date(t.updatedAt||t.createdAt).toLocaleString()}`;
          left.appendChild(title); left.appendChild(meta);

          const right = document.createElement('div'); right.className='thread-right';
          const badge = document.createElement('span'); badge.className='count-badge'; badge.textContent = count;
          const actions = document.createElement('div'); actions.className='thread-actions';
          const ren = document.createElement('button'); ren.title='Renomear'; ren.textContent='‚úé'; ren.addEventListener('click', (e)=>{ e.stopPropagation(); renameThread(t.id); });
          const del = document.createElement('button'); del.title='Excluir'; del.textContent='üóë'; del.addEventListener('click', (e)=>{ e.stopPropagation(); deleteThread(t.id); });
          actions.appendChild(ren); actions.appendChild(del);
          right.appendChild(badge); right.appendChild(actions);

          a.appendChild(left); a.appendChild(right);
          a.addEventListener('click', (e)=>{ e.preventDefault(); loadThread(t.id); });
          frag.appendChild(a);
        });
      threadsListEl.replaceChildren(frag);
    }

    function createThread(title='Nova conversa'){
      const t = { id: uid(), title, messages: [], createdAt: Date.now(), updatedAt: Date.now(), preview:'' };
      threads.unshift(t); activeThreadId = t.id; saveState(); renderThreads(threadSearch?.value||'');
      chatBody.replaceChildren(); addBot('Ol√°! Sou o **Assistente Suvinil**. Como posso ajudar hoje?'); saveActiveThreadFromDOM();
    }
    function renameThread(id){ const t = threadById(id); if(!t) return; const nv = prompt('Novo t√≠tulo da conversa:', t.title || 'Conversa'); if(nv!==null){ t.title = nv.trim() || t.title; t.updatedAt = Date.now(); saveState(); renderThreads(threadSearch?.value||''); } }
    function deleteThread(id){ const idx = threads.findIndex(t=>t.id===id); if(idx<0) return; threads.splice(idx,1); if(activeThreadId===id){ activeThreadId = threads[0]?.id || null; } saveState(); renderThreads(threadSearch?.value||''); if(activeThreadId){ loadThread(activeThreadId); } else { chatBody.replaceChildren(); } }
    function loadThread(id){ const t = threadById(id); if(!t) return; activeThreadId = id; saveState(); renderThreads(threadSearch?.value||''); chatBody.replaceChildren(); t.messages.forEach(m=> addMsg(m.role, m.html, true)); setTimeout(()=>input?.focus(), 10); }
    function saveActiveThreadFromDOM(){ const t = threadById(activeThreadId); if(!t) return; const msgs = Array.from(chatBody.querySelectorAll('.msg')).map(m=>({ role: m.classList.contains('user')? 'user':'bot', html: m.querySelector('.bubble').innerHTML })); t.messages = msgs; t.updatedAt = Date.now(); t.preview = t.messages[t.messages.length-1]?.html?.replace(/<[^>]+>/g,' ').slice(0,120)||''; if(!t.title || t.title==='Nova conversa'){ t.title = deriveTitleFromMessages(t) || t.title; } saveState(); renderThreads(threadSearch?.value||''); }
    function deriveTitleFromMessages(t){ const firstUser = t.messages.find(m=>m.role==='user'); if(firstUser){ return firstUser.html.replace(/<br>/g,' ').replace(/<[^>]+>/g,' ').slice(0,42); } return null; }

    newThreadBtn?.addEventListener('click', ()=> createThread());
    threadSearch?.addEventListener('input', ()=> renderThreads(threadSearch.value||''));
    maximizeBtn?.addEventListener('click', ()=>{ chat.classList.toggle('max'); chat.style.height = chat.classList.contains('max')? 'calc(80dvh)' : 'min(68dvh, 720px)'; });

    const suggestions = ['Produtos', 'Aplica√ß√£o', 'Cores', 'Troca e devolu√ß√£o', 'Self-Color'];
    suggestions.forEach(s=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=s; b.onclick=()=>{ addUser(s); respond(s); persist(); }; chips.appendChild(b); });

    function toggleChat(){
      document.getElementById('chat-hub')?.scrollIntoView({behavior:'smooth'});
      setTimeout(()=>input?.focus(), 60);
    }
    if(openChatBtn){ openChatBtn.addEventListener('click', ()=>{ toggleChat(); }); }

    function addMsg(role, text, silent=false){
      const wrapper = document.createElement('div');
      wrapper.className = `msg ${role}`;
      const avatar = document.createElement('div');
      avatar.className = 'bot-badge';
      avatar.textContent = role==='bot' ? 'S' : 'üòä';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = text;
      wrapper.appendChild(avatar); wrapper.appendChild(bubble);
      chatBody.appendChild(wrapper);
      chatBody.scrollTop = chatBody.scrollHeight;
      if(!silent){ saveActiveThreadFromDOM(); }
    }

    function addUser(text){
      const safe = escapeHtml(text).replace(/\n/g,'<br>');
      addMsg('user', safe);
    }
    function addBot(text){ addMsg('bot', text); }

    function escapeHtml(str){
      if (typeof str !== 'string') return '';
      const r = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
      return str.replace(/[&<>"']/g, ch => r[ch]);
    }

    // mini knowledge base para demo
    const kb = [
      { p:['troca','devolu√ß√£o','garantia'], a:'Para **trocas e devolu√ß√µes**, guarde seu comprovante e entre em contato em at√© 7 dias corridos ap√≥s o recebimento. Produtos personalizados (ex.: Self‚ÄëColor) seguem regras espec√≠ficas.'},
      { p:['aplica√ß√£o','preparo','rendimento','m¬≤','metros'], a:'Para **aplica√ß√£o**, lixe levemente, limpe a superf√≠cie e aplique 2 a 3 dem√£os conforme o **rendimento indicado na embalagem**. Aguarde o tempo de secagem entre dem√£os.'},
      { p:['cores','tend√™ncia','combinar'], a:'Escolha **cores** considerando ilumina√ß√£o e tamanho do ambiente. Tons quentes (ex.: laranjas Suvinil) criam aconchego; frios ampliam espa√ßos. Teste antes com adesivos ou amostras.'},
      { p:['self-color','tingimento','pasta','m√°quina'], a:'**Self‚ÄëColor** √© o sistema de tingimento em m√°quina. As receitas garantem repetibilidade. Guarde o c√≥digo da cor para futuras compras.'},
      { p:['produto','qual tinta','acabamento','fosco','acetinado','semibrilho'], a:'Para **acabamentos**: *Fosco* disfar√ßa imperfei√ß√µes; *Acetinado* facilita a limpeza; *Semibrilho* √© mais resistente em √°reas √∫midas.'},
    ];

    function findFaq(q){
      const t = q.toLowerCase();
      for(const item of kb){ if(item.p.some(k=>t.includes(k))) return item.a; }
      return null;
    }

    function respond(q){
      const hit = findFaq(q);
      if(hit){ addBot(hit + '<br><small style="color:var(--muted)">Dica: se quiser, pergunte por *produtos*, *aplica√ß√£o*, *cores* ou *trocas*.</small>'); return; }
      addBot('Posso ajudar com **produtos**, **aplica√ß√£o**, **cores** e **trocas/devolu√ß√µes**. Descreva sua d√∫vida ou clique em uma sugest√£o acima.');
    }

    // init + persist
    (function initChat(){
      loadState();
      if(!threads.length){ createThread('Nova conversa'); }
      else { renderThreads(); if(activeThreadId){ loadThread(activeThreadId); } else { loadThread(threads[0].id); } }
    })();
    function persist(){ saveActiveThreadFromDOM(); }

    sendBtn.addEventListener('click', ()=>{ const val=input.value.trim(); if(!val) return; addUser(val); input.value=''; respond(val); persist(); });
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }});

    // auto-grow textarea
    input.addEventListener('input', ()=>{ input.style.height='auto'; input.style.height = Math.min(input.scrollHeight, 160) + 'px'; });

    // viewport/keyboard insets (iOS/Android)
    function updateViewportInsets(){
      let kb = 0; const vv = window.visualViewport;
      if(vv && window.innerHeight){ kb = Math.max(0, Math.round(window.innerHeight - vv.height)); }
      document.documentElement.style.setProperty('--kb-offset', kb + 'px');
    }
    if(window.visualViewport){
      window.visualViewport.addEventListener('resize', updateViewportInsets);
      window.visualViewport.addEventListener('scroll', updateViewportInsets);
    }
    window.addEventListener('resize', updateViewportInsets);
    updateViewportInsets();

    /* ---------- Self-tests (console) ---------- */
    (function runSelfTests(){
      try {
        console.group('%cSelf-tests','color: #f37021; font-weight:600');
        // Test 1: newline replacement
        const sampleIn = 'Linha 1\nLinha 2';
        const out = escapeHtml(sampleIn).replace(/\n/g,'<br>');
        console.assert(out === 'Linha 1<br>Linha 2', 'Test 1 failed: newline‚Üí<br>');

        // Test 2: escapeHtml
        const escaped = escapeHtml('<b>& test</b>');
        console.assert(escaped === '&lt;b&gt;&amp; test&lt;/b&gt;', 'Test 2 failed: escapeHtml');

        // Test 3: theme toggle toggles attribute
        const before = document.documentElement.getAttribute('data-theme')||'light';
        applyTheme(before==='light'?'dark':'light');
        const after = document.documentElement.getAttribute('data-theme');
        console.assert(before !== after, 'Test 3 failed: theme toggle');
        // restore
        applyTheme(before);

        // Test 4: category render builds correct list
        renderCategory('Produtos');
        const list = document.querySelector('#faq .faq-list');
        console.assert(list && list.querySelectorAll('a').length === CAT_QUESTIONS['Produtos'].length, 'Test 4 failed: produtos length mismatch');

        // Test 5: search returns at least one result for "azulejos"
        document.getElementById('search').value = 'azulejos';
        performSearch();
        const resultsCount = document.querySelectorAll('#faq .faq-list a').length;
        console.assert(resultsCount >= 1, 'Test 5 failed: search results');

        // Test 6: findFaq returns null for unknown term and non-null for known keyword
        console.assert(findFaq('termo-inexistente') === null, 'Test 6a failed: findFaq null');
        console.assert(findFaq('qual tinta para aplica√ß√£o?') !== null, 'Test 6b failed: findFaq match');

        // Test 7: kb-offset CSS var is set
        updateViewportInsets();
        const kbVar = getComputedStyle(document.documentElement).getPropertyValue('--kb-offset').trim();
        console.assert(kbVar.endsWith('px'), 'Test 7 failed: --kb-offset not set');
        // Test 8: textarea grows on input
        const prevH = parseFloat(getComputedStyle(input).height);
        input.value = 'linha1\nlinha2\nlinha3\nlinha4';
        input.dispatchEvent(new Event('input'));
        const newH = parseFloat(getComputedStyle(input).height);
        console.assert(newH >= prevH, 'Test 8 failed: textarea did not grow');

        // Test 9: addUser converts \n to <br>
        const beforeCount = chatBody.querySelectorAll('.msg').length;
        addUser('x\ny');
        const msgs = chatBody.querySelectorAll('.msg');
        const lastBubble = msgs[msgs.length-1].querySelector('.bubble');
        console.assert(lastBubble.innerHTML === 'x<br>y', 'Test 9 failed: newline not converted to <br> in bubble');

        // Test 10: threads init
        const listCount = document.querySelectorAll('.thread-item').length; console.assert(listCount >= 1, 'Test 10 failed: threads not rendered');
        // Test 11: createThread adds one
        const beforeT = document.querySelectorAll('.thread-item').length; createThread('Teste');
        const afterT = document.querySelectorAll('.thread-item').length; console.assert(afterT === beforeT + 1, 'Test 11 failed: createThread did not add');

        // Test 12: thread meta shows count and last responder
        const firstMeta = document.querySelector('.thread-item .thread-meta')?.textContent || '';
        console.assert(/\b(\d+) msg/.test(firstMeta) && firstMeta.includes('√∫ltimo'), 'Test 12 failed: thread meta missing count/last');

        console.groupEnd();
      } catch(e){
        console.error('Self-tests error:', e);
      }
    })();

    /* ---------- Misc ---------- */
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); document.getElementById('search').focus(); }});
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
